(import [:node:fs/promises [opendir readFile writeFile]]
        [:node:path [join dirname]]
        [:node:url [fileURLToPath]]
        [:bun:test [test expect]]
        [:../src/transpiler.dak [transpileStr]])

(const root (-> import.meta.url fileURLToPath dirname dirname))
(const tour-dir "./www/tour")
(const snapshots-dir "./test/tour")
(const update-snapshots (= process.env.UPDATE_SNAPSHOTS "1"))

(for@ [ent @(opendir (join root tour-dir))]
  (test ent.name
    (fn@ []
      (let [contents @(readFile (join root tour-dir ent.name) :utf8)
            actual (.replaceAll (. (transpileStr contents) :code) ";" "\n")
            snapshot-file (join root snapshots-dir (.replace ent.name #/\.dak$/ ".js"))]
        (if update-snapshots
          @(writeFile snapshot-file actual)
          (-> @(readFile snapshot-file :utf8) expect (.toEqual actual)))))))
