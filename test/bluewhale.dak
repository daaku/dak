(import [:node:fs/promises [opendir readFile]]
        [:node:path [join]]
        [:node:url [fileURLToPath]]
        [:node:test [test]]
        [:../src/transpiler.dak [transpileStr]])

(const root (-> import.meta.url fileURLToPath (join "../__data__/bluewhale")))

(fn sanitize-stack [stack]
  (and stack (-> stack (.replace (str (join root "../../..") "/") ""))))

(const AsyncFunction (. (fn@ []) :constructor))

(for@ [ent @(opendir root)]
  (test ent.name
    (fn@ [t]
      (let [out (try
                   @((-> (join root ent.name) (readFile {:encoding :utf8}) await
                         (transpileStr {:source ent.name :sourcemap :inline})
                         (. :code)
                         AsyncFunction))
                   (catch e `${e.message}\n\n--\n\n${(sanitize-stack e.stack)}`))]
        (t.assert.snapshot out)))))
